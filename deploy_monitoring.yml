---
 - hosts: all
   ignore_unreachable: True
   gather_facts: False
   tasks:

 - name: Check Ansible
   import_playbook: ansible_check.yml
   when: provision_check is defined and provision_check
   tags: deploy, ssh, check
# - name: ACK 
#   meta: clear_host_errors

 - hosts: all
   vars:
     nagios_packages:
#       - "nagios-hardware-plugins"
       - "nagios-common"
       - "nagios-linux-plugins"
       - "nagios-common-plugins"
       - "nrpe"
     docker_packages:
       - "docker-ce"
       - "docker-engine"
       - "docker-engine-selinux"
     docker_plugin_name: "./files/check_docker.py"
     docker_plugin_conf: "./files/check_docker.cf"
     nrpe_config_dir: "/etc/nagios"
     nrpe_config_file: "{{ nrpe_config_dir }}/nrpe.cfg"
     nrpe_template: "nrpe.tmpl"
     nrpe_user: "nrpe"

   #gather_facts: no
   become: true
   become_user: "root" 


   tasks:

   - name: Deploying Nagios plugins stuff and NRPE agent ({{ nagios_packages }})
     yum:
      name: "{{ nagios_packages }}"
      state: latest

   - name: Gathering installed packages
     package_facts:
       manager: auto

   - name: Checking for a Docker host
     debug:
       msg: "{{ ansible_facts[\"nodename\"] }} is a Docker engine host"
     with_items: "{{ docker_packages }}"
     when: item in ansible_facts.packages
   
   - block:   
       - name: Copying Docker plugin script
         copy:
          src: "{{ docker_plugin_name }}"
          dest: /usr/local/nagios/libexec/check_docker
          mode: 0755
          owner: nagios
          group: root
       - name: Copying Docker plugin configuration
         copy:
          src: "{{ docker_plugin_conf }}"
          dest: "/etc/nrpe/config/check_docker.cfg"
          mode: 0655
          owner: nagios
          group: root
       - name: Adding NRPE user ('{{nrpe_user}}')to Docker group
         user:
          name: "{{nrpe_user}}"
          append: true
          groups: 'docker'
          state: present

   - name: Checking for a VM target
     debug:
       msg: "{{ ansible_facts[\"nodename\"] }} is a VM"
     when: ansible_virtualization_role == "guest"

   - name: Deploy NRPE configuration file from template to {{ nrpe_config_file }} on {{ ansible_facts['nodename'] }} 
     template:
      src: "{{ nrpe_template }}"
      dest: "{{ nrpe_config_file }}"
      owner: root
      group: wheel
      mode: 0644
     notify:
       - restart nrpe_agent

   handlers:
   - name: restart nrpe_agent
     service:
       name=nrpe
       state=restarted

 - hosts: all
   gather_facts: False
 - name: Centreon commit
   import_playbook: centreon.yml
   tags: centreon
