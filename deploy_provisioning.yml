--- 
 - hosts: Linux
   gather_facts: False
   ignore_unreachable: True
   vars:
     #- provision_password: "!"
     - provision_username: "ansible"
     - provision_pbk_path: "~{{ provision_username }}/.ssh/id_rsa.pub"
     - ansible_user: "{{ raw_host_username }}"
     - ansible_ssh_pass: "{{ raw_host_password }}"
     - ansible_become: True
     - ansible_become_pass: "{{ ansible_ssh_pass }}"
#   remote_user: root
   become: true
   become_user: "root" 
   tasks:
   - name: Assigning "{{ provision_username }}" user to Docker group
     set_fact:
       usergrp: "docker,wheel"
     when: docker_host|d(false)

   - name: Gathering installed packages
     package_facts:
       manager: auto
   - name: Checking for a Docker host
     set_fact:
       docker_host: True
     with_items: "{{ docker_packages|d('VOID') }}"
     when: item in ansible_facts.packages

   - name: Creating "{{ provision_username }}" service account.
     user:
       name: "{{ provision_username }}"
       password: "{{ provision_password }}"
       append: false
       groups: "{{ usergrp|d('wheel') }}"
       state: present
 
   - name: "Adding {{ provision_username }} sudoers entry (/etc/sudoers.d/{{ provision_username }})"
     copy:
          dest: "/etc/sudoers.d/{{ provision_username }}"
          content: "{{ provision_username }}  ALL=(ALL)  NOPASSWD: ALL"
 
   - name: Pushing "{{ provision_username }}" SSH public key to {{ provision_pbk_path }}
     authorized_key: user={{ provision_username }}
                     key={{ lookup("file",provision_pbk_path) }}
                     manage_dir=true
                     exclusive=true
                     comment="###{{ provision_username }} public_key###"

   - name: Enabling SSHD password authent
     lineinfile:
           dest="/etc/ssh/sshd_config"
           regexp="^PasswordAuthentication"
           line="PasswordAuthentication yes"
           state=present
           backup=yes
     notify:
       - restart_ssh
 
   - name: Disabling SSHD root login method
     lineinfile:
           dest="/etc/ssh/sshd_config"
           regexp="^PermitRootLogin"
           line="PermitRootLogin no"
           state=present
           backup=yes
     notify:
       - restart_ssh
   - name: Configuring SFTP subsystem
     lineinfile:
           dest="/etc/ssh/sshd_config"
           regexp="Subsystem.*sftp.*[/usr/libexec/openssh/sftp-server|internal-sftp]"
           line="Subsystem sftp internal-sftp"
           state=present
           backup=yes
     notify:
       - restart_ssh

   handlers:
   - name: restart_ssh
     service:
       name=sshd
       state=restarted
