---
 - hosts: all
   vars:
     #- provision_password: "!"
     - provision_username: "ansible"
     - provision_pbk_path: "~{{ provision_username }}/.ssh/id_rsa.pub"
     - ansible_user: "{{ raw_host_username }}"
     - ansible_ssh_pass: "{{ raw_host_password }}"
     - ansible_become: True
     - ansible_become_pass: "{{ ansible_ssh_pass }}"
   gather_facts: no
#   remote_user: root
   become: true
   become_user: "root" 
   tasks:
 
   - name: Creating "{{ provision_username }}" service account.
     user:
          name="{{ provision_username }}"
          password="{{ provision_password }}"
          append=false
          groups="docker,wheel"
          state=present
 
   - name: Adding "{{ provision_username }}" sudoers entry (/etc/sudoers.d/{{ provision_username }})
     copy:
          dest: "/etc/sudoers.d/{{ provision_username }}"
          content: "{{ provision_username }}  ALL=(ALL)  NOPASSWD: ALL"
 
   - name: Pushing "{{ provision_username }}" SSH public key to {{ provision_pbk_path }}
     authorized_key: user={{ provision_username }}
                     key={{ lookup("file",provision_pbk_path) }}
                     manage_dir=true
                     exclusive=true
                     comment="###{{ provision_username }} public_key###"

   - name: Disabling SSHD password authent
     lineinfile:
           dest="/etc/ssh/sshd_config"
           regexp="^PasswordAuthentication"
           line="PasswordAuthentication no"
           state=present
           backup=yes
     notify:
       - restart ssh
 
   - name: Disabling SSHD root login method
     lineinfile:
           dest="/etc/ssh/sshd_config"
           regexp="^PermitRootLogin"
           line="PermitRootLogin no"
           state=present
           backup=yes
     notify:
       - restart ssh
   handlers:
   - name: Restarting ssh
     service:
       name=sshd
       state=restarted
